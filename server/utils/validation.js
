const dangerousExtensions = [
  'exe', 'dll', 'bat', 'cmd', 'sh', 'php', 'jsp', 'asp', 'aspx',
  'jar', 'war', 'ear', 'py', 'rb', 'pl', 'cgi', 'msi', 'com',
  'scr', 'pif', 'vbs', 'js', 'wsf', 'wsh', 'ps1', 'psm1'
]

const allowedMimeTypes = [
  'image/', 'video/', 'audio/', 'text/', 'application/pdf',
  'application/json', 'application/xml', 'application/zip',
  'application/x-rar-compressed', 'application/gzip',
  'application/msword', 'application/vnd.openxmlformats',
  'application/vnd.ms-excel', 'application/vnd.ms-powerpoint'
]

export function validateFile(file) {
  const ext = file.originalname.split('.').pop().toLowerCase()
  
  if (dangerousExtensions.includes(ext)) {
    return false
  }

  const isAllowedType = allowedMimeTypes.some(type => 
    file.mimetype.startsWith(type)
  )

  if (!isAllowedType && file.mimetype !== 'application/octet-stream') {
    return false
  }

  if (file.size > 100 * 1024 * 1024) {
    return false
  }

  return true
}

export function sanitizeFilename(filename) {
  return filename
    .replace(/[^a-zA-Z0-9.-]/g, '_')
    .replace(/_{2,}/g, '_')
    .substring(0, 100)
}
