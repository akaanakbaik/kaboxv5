import express from 'express'
import multer from 'multer'
import path from 'path'
import { selectDatabase, saveToDatabase } from '../config/database.js'
import { telegramBot } from '../services/telegram.js'
import { validateFile } from '../utils/validation.js'
import { encryptFile, generateFileId } from '../utils/security.js'

const router = express.Router()

const storage = multer.memoryStorage()

const upload = multer({
  storage,
  limits: {
    fileSize: 100 * 1024 * 1024,
    files: 5
  },
  fileFilter: (req, file, cb) => {
    const valid = validateFile(file)
    if (valid) {
      cb(null, true)
    } else {
      cb(new Error('Invalid file type or dangerous extension'), false)
    }
  }
})

router.post('/', upload.array('files', 5), async (req, res) => {
  try {
    if (!req.files || req.files.length === 0) {
      return res.status(400).json({
        author: "aka",
        email: "akaanakbaik17@proton.me",
        success: false,
        error: "No files uploaded"
      })
    }

    const results = []
    
    for (const file of req.files) {
      const dbName = await selectDatabase(file, 'random')
      const fileId = generateFileId()
      const encryptedData = encryptFile(file.buffer)
      
      const metadata = {
        id: fileId,
        name: file.originalname,
        size: file.size,
        type: file.mimetype,
        db: dbName
      }

      const dbResult = await saveToDatabase(dbName, encryptedData, metadata)
      
      const result = {
        id: fileId,
        url: `https://kabox.my.id/files/${fileId}${path.extname(file.originalname)}`,
        name: file.originalname,
        size: file.size,
        type: file.mimetype,
        createdAt: new Date().toISOString()
      }

      results.push(result)
      
      telegramBot.notifyUpload({
        ...metadata,
        db: dbName
      })
    }

    res.json({
      author: "aka",
      email: "akaanakbaik17@proton.me",
      success: true,
      data: results
    })

  } catch (error) {
    console.error('Upload error:', error)
    telegramBot.notifyError('Upload Failed', error.message)
    res.status(500).json({
      author: "aka",
      email: "akaanakbaik17@proton.me",
      success: false,
      error: "Internal server error"
    })
  }
})

export default router
